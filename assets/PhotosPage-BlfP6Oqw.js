import{b as $,r as j,c as D,j as m}from"./index-Di4G67OU.js";var _={exports:{}};(function(l,f){(function(d,i){l.exports=i(j)})(D,function(b){return function(d){var i={};function n(r){if(i[r])return i[r].exports;var u=i[r]={i:r,l:!1,exports:{}};return d[r].call(u.exports,u,u.exports,n),u.l=!0,u.exports}return n.m=d,n.c=i,n.d=function(r,u,c){n.o(r,u)||Object.defineProperty(r,u,{enumerable:!0,get:c})},n.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n.t=function(r,u){if(u&1&&(r=n(r)),u&8||u&4&&typeof r=="object"&&r&&r.__esModule)return r;var c=Object.create(null);if(n.r(c),Object.defineProperty(c,"default",{enumerable:!0,value:r}),u&2&&typeof r!="string")for(var x in r)n.d(c,x,(function(y){return r[y]}).bind(null,x));return c},n.n=function(r){var u=r&&r.__esModule?function(){return r.default}:function(){return r};return n.d(u,"a",u),u},n.o=function(r,u){return Object.prototype.hasOwnProperty.call(r,u)},n.p="",n(n.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(d,i,n){n.r(i);var r=n("react"),u=function(){var h=function(s,e){return h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var a in o)o.hasOwnProperty(a)&&(t[a]=o[a])},h(s,e)};return function(s,e){h(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),c=function(){return c=Object.assign||function(h){for(var s,e=1,t=arguments.length;e<t;e++){s=arguments[e];for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(h[o]=s[o])}return h},c.apply(this,arguments)},x=function(h,s){var e={};for(var t in h)Object.prototype.hasOwnProperty.call(h,t)&&s.indexOf(t)<0&&(e[t]=h[t]);if(h!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,t=Object.getOwnPropertySymbols(h);o<t.length;o++)s.indexOf(t[o])<0&&Object.prototype.propertyIsEnumerable.call(h,t[o])&&(e[t[o]]=h[t[o]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(s){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,o){e.call(navigator,s,t,o)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function y(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var g=function(h){u(s,h);function s(e){var t=h.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return s.prototype.componentDidMount=function(){var e=this,t=e.state,o=e.props;if(this.unmounted=!1,!y()){o.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),o.children&&typeof o.children!="function"&&console.warn("children must be a function")},s.prototype.componentDidUpdate=function(e){var t=this.props;if(!y()){t.onUserMediaError("getUserMedia not supported");return}var o=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),a=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),S=e.minScreenshotWidth!==t.minScreenshotWidth,p=e.minScreenshotHeight!==t.minScreenshotHeight;(a||S||p)&&(this.canvas=null,this.ctx=null),(o||a)&&(this.stopAndCleanup(),this.requestUserMedia())},s.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},s.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},s.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(s.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},s.prototype.getScreenshot=function(e){var t=this,o=t.state,a=t.props;if(!o.hasUserMedia)return null;var S=this.getCanvas(e);return S&&S.toDataURL(a.screenshotFormat,a.screenshotQuality)},s.prototype.getCanvas=function(e){var t=this,o=t.state,a=t.props;if(!this.video||!o.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var S=this.video.videoWidth,p=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var w=S/p;S=a.minScreenshotWidth||this.video.clientWidth,p=S/w,a.minScreenshotHeight&&p<a.minScreenshotHeight&&(p=a.minScreenshotHeight,S=p*w)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||S,this.canvas.height=(e==null?void 0:e.height)||p,this.ctx=this.canvas.getContext("2d")}var M=this,U=M.ctx,v=M.canvas;return U&&v&&(v.width=(e==null?void 0:e.width)||v.width,v.height=(e==null?void 0:e.height)||v.height,a.mirrored&&(U.translate(v.width,0),U.scale(-1,1)),U.imageSmoothingEnabled=a.imageSmoothing,U.drawImage(this.video,0,0,(e==null?void 0:e.width)||v.width,(e==null?void 0:e.height)||v.height),a.mirrored&&(U.scale(-1,1),U.translate(-v.width,0))),v},s.prototype.requestUserMedia=function(){var e=this,t=this.props,o=function(p,w){var M={video:typeof w<"u"?w:!0};t.audio&&(M.audio=typeof p<"u"?p:!0),e.requestUserMediaId++;var U=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(M).then(function(v){e.unmounted||U!==e.requestUserMediaId?s.stopMediaStream(v):e.handleUserMedia(null,v)}).catch(function(v){e.handleUserMedia(v)})};if("mediaDevices"in navigator)o(t.audioConstraints,t.videoConstraints);else{var a=function(p){return{optional:[{sourceId:p}]}},S=function(p){var w=p.deviceId;return typeof w=="string"?w:Array.isArray(w)&&w.length>0?w[0]:typeof w=="object"&&w.ideal?w.ideal:null};MediaStreamTrack.getSources(function(p){var w=null,M=null;p.forEach(function(k){k.kind==="audio"?w=k.id:k.kind==="video"&&(M=k.id)});var U=S(t.audioConstraints);U&&(w=U);var v=S(t.videoConstraints);v&&(M=v),o(a(w),a(M))})}},s.prototype.handleUserMedia=function(e,t){var o=this.props;if(e||!t){this.setState({hasUserMedia:!1}),o.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}o.onUserMedia(t)},s.prototype.render=function(){var e=this,t=this,o=t.state,a=t.props,S=a.audio;a.forceScreenshotSourceSize;var p=a.disablePictureInPicture;a.onUserMedia,a.onUserMediaError,a.screenshotFormat,a.screenshotQuality,a.minScreenshotWidth,a.minScreenshotHeight,a.audioConstraints,a.videoConstraints,a.imageSmoothing;var w=a.mirrored,M=a.style,U=M===void 0?{}:M,v=a.children,k=x(a,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),E=w?c(c({},U),{transform:(U.transform||"")+" scaleX(-1)"}):U,T={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",c({autoPlay:!0,disablePictureInPicture:p,src:o.src,muted:!S,playsInline:!0,ref:function(A){e.video=A},style:E},k)),v&&v(T))},s.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},s}(r.Component);i.default=g},react:function(d,i){d.exports=b}}).default})})(_);var F=_.exports;const W=$(F);function R({onCapture:l,disabled:f=!1}){const b=j.useRef(null),[d,i]=j.useState(null),n=parseInt("1080",10),r=Math.min(Math.max(parseFloat("1"),.1),1),u=j.useCallback(()=>{if(i(null),!b.current)return;const c=b.current,x=c.video,y=g=>{try{const[h,s]=g.split(","),e=/data:(.*?);base64/.exec(h||""),t=e?e[1]:"image/jpeg",o=atob(s||""),a=o.length,S=new Uint8Array(a);for(let p=0;p<a;p++)S[p]=o.charCodeAt(p);return new Blob([S],{type:t})}catch(h){return console.error("dataUrlToBlob failed",h),null}};try{if(x&&x.readyState>=2){const g=x.videoWidth,h=x.videoHeight;if(!g||!h)throw new Error("Unable to read camera size");const s=g>n?n/g:1,e=Math.round(g*s),t=Math.round(h*s),o=document.createElement("canvas");o.width=e,o.height=t;const a=o.getContext("2d");try{a.drawImage(x,0,0,e,t)}catch(M){if(typeof c.getScreenshot=="function"){const U=c.getScreenshot();if(!U)throw M;const v=y(U);if(!v)throw new Error("Fallback conversion failed");const k=U.split(",")[1]||"",E=Math.round(k.length*3/4);l({dataUrl:U,blob:v,width:e,height:t,approxSize:E});return}throw M}const S=o.toDataURL("image/jpeg",r),p=S.split(",")[1]||"",w=Math.round(p.length*3/4);o.toBlob(M=>{if(!M){i("Conversion failed");return}l({dataUrl:S,blob:M,width:e,height:t,approxSize:w})},"image/jpeg",r);return}if(typeof c.getScreenshot=="function"){const g=c.getScreenshot();if(!g)throw new Error("Camera not ready");const h=g.split(",")[1]||"",s=Math.round(h.length*3/4),e=y(g);if(!e)throw new Error("Fallback conversion failed");l({dataUrl:g,blob:e,width:n,height:Math.round(n*3/4),approxSize:s});return}throw new Error("Camera not ready")}catch(g){console.error("Capture error",g),i(g.message||"Capture failed")}},[l,n,r]);return m.jsxs("div",{className:"photo-capture",children:[m.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:m.jsx(W,{ref:b,audio:!1,mirrored:!0,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),d&&m.jsx("p",{className:"capture-error",role:"alert",children:d}),m.jsx("button",{className:"btn primary",onClick:u,disabled:f,type:"button",children:"Capture"})]})}function z({dataUrl:l,onRetake:f,onUpload:b,uploading:d}){return l?m.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[m.jsx("img",{src:l,alt:"Captured preview",className:"preview-image"}),m.jsxs("div",{className:"actions",children:[m.jsx("button",{className:"btn",type:"button",onClick:f,disabled:d,children:"Retake"}),m.jsx("button",{className:"btn primary",type:"button",onClick:b,disabled:d,children:d?"Uploading…":"Upload"})]})]}):null}function B({url:l,error:f,onReset:b,meta:d}){if(!l&&!f)return null;const i=l&&/storage\.rcs-rds\.ro/.test(l),n=i?"Stored in DigiStorage ✅":"Upload successful",r=i?"Your photo is now saved securely in DigiStorage.":null;return m.jsxs("div",{className:"upload-status",role:"status",children:[l&&m.jsxs("div",{className:"success-block",children:[m.jsx("p",{children:n}),r&&m.jsx("p",{className:"storage-note",children:r}),d&&m.jsxs("p",{className:"meta-note",children:["Resolution: ",d.width,"×",d.height,"px · Approx ",(d.approxSize/1024).toFixed(1)," KB"]}),m.jsx("a",{href:l,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),f&&m.jsx("div",{className:"error-block",role:"alert",children:m.jsx("p",{children:f})}),m.jsx("button",{type:"button",className:"btn",onClick:b,children:l?"Upload Another":"Try Again"})]})}let C=null;const H="https://storage.rcs-rds.ro";function L(){return H.replace(/\/$/,"")}function P(){return L()}function I(){return`${P()}/api/v2`}function q(){return`${P()}/content/api/v2`}async function G(l,f){return new Promise((b,d)=>{const i=new FileReader;i.onerror=()=>d(i.error),i.onload=()=>{b(i.result)},i.readAsDataURL(l)})}async function O(){return"490b2d11-2568-428c-a4a7-f1cd7f30d5bd".trim()}async function N(){if(C)return C;const l=await O(),f=await fetch(`${I()}/mounts`,{headers:{Authorization:`Token token="${l}"`,Accept:"application/json"}});if(!f.ok){const n=await f.text();throw new Error(`Failed to list mounts: ${f.status} ${n}`)}const i=((await f.json()).mounts||[]).find(n=>n.type==="device");if(!i)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return C=i.id,C}async function V(l,f,b){const d=await O(),i=await N(),n=l.endsWith("/")?l:l+"/",r=`${q()}/mounts/${i}/files/put?path=${encodeURIComponent(n)}`,u=new FormData;u.append("file",b,f);const c=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${d}"`},body:u});if(!c.ok){const x=await c.text();throw new Error(`Upload failed: ${c.status} ${x}`)}return c.json().catch(()=>null)}async function J(l){const f=await O(),b=await N(),d=`${I()}/mounts/${b}/files/download?path=${encodeURIComponent(l)}`,i=await fetch(d,{headers:{Authorization:`Token token="${f}"`,Accept:"application/json"}});if(!i.ok){const r=await i.text();throw new Error(`Failed to obtain download link: ${i.status} ${r}`)}const n=await i.json();if(!n.link)throw new Error("Download link response missing `link`");return n.link}async function Q({blob:l,fileName:f,contentType:b="image/jpeg"}){if(!(l instanceof Blob))throw new Error("blob must be a Blob");if(!f)throw new Error("fileName required");const d="/uploads".trim(),i=d.startsWith("/")?d:"/"+d,n=async()=>{console.log("📤 Attempting direct DigiStorage upload (token mode)...");try{await V(i,f,l);const y=(i.endsWith("/")?i:i+"/")+f,g=await J(y);return console.log("✅ Direct DigiStorage upload succeeded"),g}catch(y){throw console.error("❌ Direct upload failed:",y),y}},r="/.netlify/functions/upload-photo",u=await G(l);let c;try{c=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:f,dataUrl:u})})}catch(y){return console.warn("⚠️ Serverless upload unreachable, attempting direct token mode fallback...",y.message),n()}if(!c.ok){const y=await c.text();console.warn(`⚠️ Serverless upload failed (${c.status}). Will attempt direct token mode. Details: ${y}`);try{return await n()}catch(g){throw new Error(`Serverless failed (${c.status}); Direct token attempt also failed: ${g.message}`)}}const x=await c.json().catch(()=>({}));return x.url?(console.log("✅ DigiStorage upload complete via serverless function"),x.url):(console.warn("⚠️ Serverless response missing url, attempting direct token mode"),n())}function X(){const[l,f]=j.useState(null),[b,d]=j.useState(null),[i,n]=j.useState(null),[r,u]=j.useState(!1),[c,x]=j.useState(null),[y,g]=j.useState(null),h=j.useCallback(()=>{f(null),d(null),n(null),u(!1),x(null),g(null)},[]),s=t=>{f(t.dataUrl),d(t.blob),n({width:t.width,height:t.height,approxSize:t.approxSize}),g(null)},e=async()=>{if(b)try{u(!0),g(null);const t=`photo_${Date.now()}.jpg`,o=await Q({blob:b,fileName:t});x(o)}catch(t){console.error(t),g(t.message||"Upload failed")}finally{u(!1)}};return m.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[m.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!l&&!c&&!y&&m.jsx(R,{onCapture:s,disabled:r}),l&&!c&&!y&&m.jsx(z,{dataUrl:l,onRetake:h,onUpload:e,uploading:r}),(c||y)&&m.jsx(B,{url:c,error:y,onReset:h,meta:i}),m.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely."})]})}export{X as default};
