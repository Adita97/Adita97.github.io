import{b as F,r as M,c as W,j as p}from"./index-RtY4FciJ.js";var I={exports:{}};(function(s,l){(function(a,c){s.exports=c(M)})(W,function(f){return function(a){var c={};function n(r){if(c[r])return c[r].exports;var u=c[r]={i:r,l:!1,exports:{}};return a[r].call(u.exports,u,u.exports,n),u.l=!0,u.exports}return n.m=a,n.c=c,n.d=function(r,u,h){n.o(r,u)||Object.defineProperty(r,u,{enumerable:!0,get:h})},n.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n.t=function(r,u){if(u&1&&(r=n(r)),u&8||u&4&&typeof r=="object"&&r&&r.__esModule)return r;var h=Object.create(null);if(n.r(h),Object.defineProperty(h,"default",{enumerable:!0,value:r}),u&2&&typeof r!="string")for(var U in r)n.d(h,U,(function(j){return r[j]}).bind(null,U));return h},n.n=function(r){var u=r&&r.__esModule?function(){return r.default}:function(){return r};return n.d(u,"a",u),u},n.o=function(r,u){return Object.prototype.hasOwnProperty.call(r,u)},n.p="",n(n.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(a,c,n){n.r(c);var r=n("react"),u=function(){var v=function(d,e){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o])},v(d,e)};return function(d,e){v(d,e);function t(){this.constructor=d}d.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),h=function(){return h=Object.assign||function(v){for(var d,e=1,t=arguments.length;e<t;e++){d=arguments[e];for(var i in d)Object.prototype.hasOwnProperty.call(d,i)&&(v[i]=d[i])}return v},h.apply(this,arguments)},U=function(v,d){var e={};for(var t in v)Object.prototype.hasOwnProperty.call(v,t)&&d.indexOf(t)<0&&(e[t]=v[t]);if(v!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,t=Object.getOwnPropertySymbols(v);i<t.length;i++)d.indexOf(t[i])<0&&Object.prototype.propertyIsEnumerable.call(v,t[i])&&(e[t[i]]=v[t[i]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(d){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,i){e.call(navigator,d,t,i)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function j(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var x=function(v){u(d,v);function d(e){var t=v.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return d.prototype.componentDidMount=function(){var e=this,t=e.state,i=e.props;if(this.unmounted=!1,!j()){i.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),i.children&&typeof i.children!="function"&&console.warn("children must be a function")},d.prototype.componentDidUpdate=function(e){var t=this.props;if(!j()){t.onUserMediaError("getUserMedia not supported");return}var i=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),o=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),b=e.minScreenshotWidth!==t.minScreenshotWidth,w=e.minScreenshotHeight!==t.minScreenshotHeight;(o||b||w)&&(this.canvas=null,this.ctx=null),(i||o)&&(this.stopAndCleanup(),this.requestUserMedia())},d.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},d.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},d.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(d.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},d.prototype.getScreenshot=function(e){var t=this,i=t.state,o=t.props;if(!i.hasUserMedia)return null;var b=this.getCanvas(e);return b&&b.toDataURL(o.screenshotFormat,o.screenshotQuality)},d.prototype.getCanvas=function(e){var t=this,i=t.state,o=t.props;if(!this.video||!i.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var b=this.video.videoWidth,w=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var m=b/w;b=o.minScreenshotWidth||this.video.clientWidth,w=b/m,o.minScreenshotHeight&&w<o.minScreenshotHeight&&(w=o.minScreenshotHeight,b=w*m)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||b,this.canvas.height=(e==null?void 0:e.height)||w,this.ctx=this.canvas.getContext("2d")}var S=this,y=S.ctx,g=S.canvas;return y&&g&&(g.width=(e==null?void 0:e.width)||g.width,g.height=(e==null?void 0:e.height)||g.height,o.mirrored&&(y.translate(g.width,0),y.scale(-1,1)),y.imageSmoothingEnabled=o.imageSmoothing,y.drawImage(this.video,0,0,(e==null?void 0:e.width)||g.width,(e==null?void 0:e.height)||g.height),o.mirrored&&(y.scale(-1,1),y.translate(-g.width,0))),g},d.prototype.requestUserMedia=function(){var e=this,t=this.props,i=function(w,m){var S={video:typeof m<"u"?m:!0};t.audio&&(S.audio=typeof w<"u"?w:!0),e.requestUserMediaId++;var y=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(S).then(function(g){e.unmounted||y!==e.requestUserMediaId?d.stopMediaStream(g):e.handleUserMedia(null,g)}).catch(function(g){e.handleUserMedia(g)})};if("mediaDevices"in navigator)i(t.audioConstraints,t.videoConstraints);else{var o=function(w){return{optional:[{sourceId:w}]}},b=function(w){var m=w.deviceId;return typeof m=="string"?m:Array.isArray(m)&&m.length>0?m[0]:typeof m=="object"&&m.ideal?m.ideal:null};MediaStreamTrack.getSources(function(w){var m=null,S=null;w.forEach(function(k){k.kind==="audio"?m=k.id:k.kind==="video"&&(S=k.id)});var y=b(t.audioConstraints);y&&(m=y);var g=b(t.videoConstraints);g&&(S=g),i(o(m),o(S))})}},d.prototype.handleUserMedia=function(e,t){var i=this.props;if(e||!t){this.setState({hasUserMedia:!1}),i.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}i.onUserMedia(t)},d.prototype.render=function(){var e=this,t=this,i=t.state,o=t.props,b=o.audio;o.forceScreenshotSourceSize;var w=o.disablePictureInPicture;o.onUserMedia,o.onUserMediaError,o.screenshotFormat,o.screenshotQuality,o.minScreenshotWidth,o.minScreenshotHeight,o.audioConstraints,o.videoConstraints,o.imageSmoothing;var m=o.mirrored,S=o.style,y=S===void 0?{}:S,g=o.children,k=U(o,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),A=m?h(h({},y),{transform:(y.transform||"")+" scaleX(-1)"}):y,D={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",h({autoPlay:!0,disablePictureInPicture:w,src:i.src,muted:!b,playsInline:!0,ref:function(R){e.video=R},style:A},k)),g&&g(D))},d.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},d}(r.Component);c.default=x},react:function(a,c){a.exports=f}}).default})})(I);var G=I.exports;const q=F(G);function z({onCapture:s,disabled:l=!1}){const f=M.useRef(null),a=M.useCallback(()=>{if(!f.current)return;const c=f.current.getScreenshot();c&&s(c)},[s]);return p.jsxs("div",{className:"photo-capture",children:[p.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:p.jsx(q,{ref:f,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),p.jsx("button",{className:"btn primary",onClick:a,disabled:l,type:"button",children:"Capture"})]})}function H({dataUrl:s,onRetake:l,onUpload:f,uploading:a}){return s?p.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[p.jsx("img",{src:s,alt:"Captured preview",className:"preview-image"}),p.jsxs("div",{className:"actions",children:[p.jsx("button",{className:"btn",type:"button",onClick:l,disabled:a,children:"Retake"}),p.jsx("button",{className:"btn primary",type:"button",onClick:f,disabled:a,children:a?"Uploading…":"Upload"})]})]}):null}function L({url:s,error:l,onReset:f}){return!s&&!l?null:p.jsxs("div",{className:"upload-status",role:"status",children:[s&&p.jsxs("div",{className:"success-block",children:[p.jsx("p",{children:"Upload successful!"}),p.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),l&&p.jsx("div",{className:"error-block",role:"alert",children:p.jsx("p",{children:l})}),p.jsx("button",{type:"button",className:"btn",onClick:f,children:s?"Upload Another":"Try Again"})]})}let C=null,P=0,E=null;const V="https://storage.rcs-rds.ro";function B(){return V.replace(/\/$/,"")}function _(){return B()}function N(){return`${_()}/api/v2`}function K(){return`${_()}/content/api/v2`}function T(){return Date.now()}async function O(){if(C&&T()-P<15*60*1e3)return C;const s="marius.adrian997@gmail.com",l="19971005Gma!",f=`${_()}/token`.replace(/\/$/,"");console.log("🔐 Attempting DigiStorage authentication...",{endpoint:f,email:(s==null?void 0:s.substring(0,5))+"..."});let a;try{a=await fetch(f,{method:"GET",headers:{"X-Koofr-Email":s,"X-Koofr-Password":l,Accept:"*/*"}})}catch(n){throw console.error("❌ Network error during DigiStorage authentication:",n),new Error(`Network error connecting to DigiStorage: ${n.message}. This might be a CORS issue - consider using a backend proxy for production.`)}if(!a.ok){const n=await a.text();throw console.error("❌ DigiStorage auth failed:",{status:a.status,text:n}),new Error(`Failed to obtain DigiStorage token (GET headers auth) ${a.status}: ${n}`)}const c=a.headers.get("X-Koofr-Token");if(console.log("🔑 DigiStorage auth response:",{status:a.status,hasToken:!!c,headers:Object.fromEntries(a.headers.entries())}),!c)throw new Error("Token header X-Koofr-Token missing in response");return C=c,P=T(),console.log("✅ DigiStorage token obtained successfully"),C}async function $(){if(E)return E;const s=await O(),l=await fetch(`${N()}/mounts`,{headers:{Authorization:`Token token="${s}"`,Accept:"application/json"}});if(!l.ok){const n=await l.text();throw new Error(`Failed to list mounts: ${l.status} ${n}`)}const c=((await l.json()).mounts||[]).find(n=>n.type==="device");if(!c)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return E=c.id,E}async function X(s,l,f){const a=await O(),c=await $(),n=s.endsWith("/")?s:s+"/",r=`${K()}/mounts/${c}/files/put?path=${encodeURIComponent(n)}`,u=new FormData;u.append("file",f,l);const h=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${a}"`},body:u});if(!h.ok){const U=await h.text();throw new Error(`Upload failed: ${h.status} ${U}`)}return h.json().catch(()=>null)}async function J(s){const l=await O(),f=await $(),a=`${N()}/mounts/${f}/files/download?path=${encodeURIComponent(s)}`,c=await fetch(a,{headers:{Authorization:`Token token="${l}"`,Accept:"application/json"}});if(!c.ok){const r=await c.text();throw new Error(`Failed to obtain download link: ${c.status} ${r}`)}const n=await c.json();if(!n.link)throw new Error("Download link response missing `link`");return n.link}async function Q({blob:s,fileName:l,contentType:f="image/jpeg"}){if(!(s instanceof Blob))throw new Error("blob must be a Blob");if(!l)throw new Error("fileName required");const a="/uploads";await X(a,l,s);const c=(a.endsWith("/")?a:a+"/")+l;return await J(c)}function Z(){const[s,l]=M.useState(null),[f,a]=M.useState(!1),[c,n]=M.useState(null),[r,u]=M.useState(null),h=M.useCallback(()=>{l(null),a(!1),n(null),u(null)},[]),U=x=>{l(x),u(null)},j=async()=>{if(s)try{a(!0),u(null);const v=await(await fetch(s)).blob(),d=`photo_${Date.now()}.jpg`,e=await Q({blob:v,fileName:d});n(e)}catch(x){console.error(x),u(x.message||"Upload failed")}finally{a(!1)}};return p.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[p.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!s&&!c&&!r&&p.jsx(z,{onCapture:U,disabled:f}),s&&!c&&!r&&p.jsx(H,{dataUrl:s,onRetake:h,onUpload:j,uploading:f}),(c||r)&&p.jsx(L,{url:c,error:r,onReset:h}),p.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{Z as default};
