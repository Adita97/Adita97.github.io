import{b as F,r as j,c as W,j as m}from"./index-3g7V5W6u.js";var I={exports:{}};(function(l,g){(function(h,s){l.exports=s(j)})(W,function(y){return function(h){var s={};function n(r){if(s[r])return s[r].exports;var d=s[r]={i:r,l:!1,exports:{}};return h[r].call(d.exports,d,d.exports,n),d.l=!0,d.exports}return n.m=h,n.c=s,n.d=function(r,d,u){n.o(r,d)||Object.defineProperty(r,d,{enumerable:!0,get:u})},n.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n.t=function(r,d){if(d&1&&(r=n(r)),d&8||d&4&&typeof r=="object"&&r&&r.__esModule)return r;var u=Object.create(null);if(n.r(u),Object.defineProperty(u,"default",{enumerable:!0,value:r}),d&2&&typeof r!="string")for(var U in r)n.d(u,U,(function(v){return r[v]}).bind(null,U));return u},n.n=function(r){var d=r&&r.__esModule?function(){return r.default}:function(){return r};return n.d(d,"a",d),d},n.o=function(r,d){return Object.prototype.hasOwnProperty.call(r,d)},n.p="",n(n.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(h,s,n){n.r(s);var r=n("react"),d=function(){var c=function(a,e){return c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o])},c(a,e)};return function(a,e){c(a,e);function t(){this.constructor=a}a.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),u=function(){return u=Object.assign||function(c){for(var a,e=1,t=arguments.length;e<t;e++){a=arguments[e];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(c[i]=a[i])}return c},u.apply(this,arguments)},U=function(c,a){var e={};for(var t in c)Object.prototype.hasOwnProperty.call(c,t)&&a.indexOf(t)<0&&(e[t]=c[t]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,t=Object.getOwnPropertySymbols(c);i<t.length;i++)a.indexOf(t[i])<0&&Object.prototype.propertyIsEnumerable.call(c,t[i])&&(e[t[i]]=c[t[i]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(a){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,i){e.call(navigator,a,t,i)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function v(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var M=function(c){d(a,c);function a(e){var t=c.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return a.prototype.componentDidMount=function(){var e=this,t=e.state,i=e.props;if(this.unmounted=!1,!v()){i.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),i.children&&typeof i.children!="function"&&console.warn("children must be a function")},a.prototype.componentDidUpdate=function(e){var t=this.props;if(!v()){t.onUserMediaError("getUserMedia not supported");return}var i=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),o=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),w=e.minScreenshotWidth!==t.minScreenshotWidth,p=e.minScreenshotHeight!==t.minScreenshotHeight;(o||w||p)&&(this.canvas=null,this.ctx=null),(i||o)&&(this.stopAndCleanup(),this.requestUserMedia())},a.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},a.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},a.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(a.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},a.prototype.getScreenshot=function(e){var t=this,i=t.state,o=t.props;if(!i.hasUserMedia)return null;var w=this.getCanvas(e);return w&&w.toDataURL(o.screenshotFormat,o.screenshotQuality)},a.prototype.getCanvas=function(e){var t=this,i=t.state,o=t.props;if(!this.video||!i.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var w=this.video.videoWidth,p=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var f=w/p;w=o.minScreenshotWidth||this.video.clientWidth,p=w/f,o.minScreenshotHeight&&p<o.minScreenshotHeight&&(p=o.minScreenshotHeight,w=p*f)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||w,this.canvas.height=(e==null?void 0:e.height)||p,this.ctx=this.canvas.getContext("2d")}var x=this,S=x.ctx,b=x.canvas;return S&&b&&(b.width=(e==null?void 0:e.width)||b.width,b.height=(e==null?void 0:e.height)||b.height,o.mirrored&&(S.translate(b.width,0),S.scale(-1,1)),S.imageSmoothingEnabled=o.imageSmoothing,S.drawImage(this.video,0,0,(e==null?void 0:e.width)||b.width,(e==null?void 0:e.height)||b.height),o.mirrored&&(S.scale(-1,1),S.translate(-b.width,0))),b},a.prototype.requestUserMedia=function(){var e=this,t=this.props,i=function(p,f){var x={video:typeof f<"u"?f:!0};t.audio&&(x.audio=typeof p<"u"?p:!0),e.requestUserMediaId++;var S=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(x).then(function(b){e.unmounted||S!==e.requestUserMediaId?a.stopMediaStream(b):e.handleUserMedia(null,b)}).catch(function(b){e.handleUserMedia(b)})};if("mediaDevices"in navigator)i(t.audioConstraints,t.videoConstraints);else{var o=function(p){return{optional:[{sourceId:p}]}},w=function(p){var f=p.deviceId;return typeof f=="string"?f:Array.isArray(f)&&f.length>0?f[0]:typeof f=="object"&&f.ideal?f.ideal:null};MediaStreamTrack.getSources(function(p){var f=null,x=null;p.forEach(function(k){k.kind==="audio"?f=k.id:k.kind==="video"&&(x=k.id)});var S=w(t.audioConstraints);S&&(f=S);var b=w(t.videoConstraints);b&&(x=b),i(o(f),o(x))})}},a.prototype.handleUserMedia=function(e,t){var i=this.props;if(e||!t){this.setState({hasUserMedia:!1}),i.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}i.onUserMedia(t)},a.prototype.render=function(){var e=this,t=this,i=t.state,o=t.props,w=o.audio;o.forceScreenshotSourceSize;var p=o.disablePictureInPicture;o.onUserMedia,o.onUserMediaError,o.screenshotFormat,o.screenshotQuality,o.minScreenshotWidth,o.minScreenshotHeight,o.audioConstraints,o.videoConstraints,o.imageSmoothing;var f=o.mirrored,x=o.style,S=x===void 0?{}:x,b=o.children,k=U(o,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),C=f?u(u({},S),{transform:(S.transform||"")+" scaleX(-1)"}):S,E={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",u({autoPlay:!0,disablePictureInPicture:p,src:i.src,muted:!w,playsInline:!0,ref:function(O){e.video=O},style:C},k)),b&&b(E))},a.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},a}(r.Component);s.default=M},react:function(h,s){h.exports=y}}).default})})(I);var R=I.exports;const z=F(R);function B({onCapture:l,disabled:g=!1}){const y=j.useRef(null),[h,s]=j.useState(null),n=parseInt("1080",10),r=parseInt("1920",10),d=Math.min(Math.max(parseFloat("1"),.1),1),u=j.useCallback(()=>{if(s(null),!y.current)return;const U=y.current,v=U.video,M=c=>{try{const[a,e]=c.split(","),t=/data:(.*?);base64/.exec(a||""),i=t?t[1]:"image/jpeg",o=atob(e||""),w=o.length,p=new Uint8Array(w);for(let f=0;f<w;f++)p[f]=o.charCodeAt(f);return new Blob([p],{type:i})}catch(a){return console.error("dataUrlToBlob failed",a),null}};try{if(v&&v.readyState>=2){const c=v.videoWidth,a=v.videoHeight;if(!c||!a)throw new Error("Unable to read camera size");const e=n/r,t=c/a;let i,o,w,p;t>e?(p=a,w=Math.round(p*e),i=Math.round((c-w)/2),o=0):(w=c,p=Math.round(w/e),i=0,o=Math.round((a-p)/2));const f=document.createElement("canvas");f.width=n,f.height=r;const x=f.getContext("2d");try{x.drawImage(v,i,o,w,p,0,0,n,r)}catch(C){if(typeof U.getScreenshot=="function"){const E=U.getScreenshot();if(!E)throw C;const O=M(E);if(!O)throw new Error("Fallback conversion failed");const $=E.split(",")[1]||"",D=Math.round($.length*3/4);l({dataUrl:E,blob:O,width:n,height:r,approxSize:D});return}throw C}const S=f.toDataURL("image/jpeg",d),b=S.split(",")[1]||"",k=Math.round(b.length*3/4);f.toBlob(C=>{if(!C){s("Conversion failed");return}l({dataUrl:S,blob:C,width:n,height:r,approxSize:k})},"image/jpeg",d);return}if(typeof U.getScreenshot=="function"){const c=U.getScreenshot();if(!c)throw new Error("Camera not ready");const a=c.split(",")[1]||"",e=Math.round(a.length*3/4),t=M(c);if(!t)throw new Error("Fallback conversion failed");l({dataUrl:c,blob:t,width:n,height:r,approxSize:e});return}throw new Error("Camera not ready")}catch(c){console.error("Capture error",c),s(c.message||"Capture failed")}},[l,n,d]);return m.jsxs("div",{className:"photo-capture",children:[m.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:m.jsx(z,{ref:y,audio:!1,mirrored:!0,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:{ideal:"user"},width:{ideal:n},height:{ideal:r}},className:"webcam-feed"})}),h&&m.jsx("p",{className:"capture-error",role:"alert",children:h}),m.jsx("button",{className:"btn primary",onClick:u,disabled:g,type:"button",children:"Capture"})]})}function H({dataUrl:l,onRetake:g,onUpload:y,uploading:h}){return l?m.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[m.jsx("img",{src:l,alt:"Captured preview",className:"preview-image"}),m.jsxs("div",{className:"actions",children:[m.jsx("button",{className:"btn",type:"button",onClick:g,disabled:h,children:"Retake"}),m.jsx("button",{className:"btn primary",type:"button",onClick:y,disabled:h,children:h?"Uploading…":"Upload"})]})]}):null}function L({url:l,error:g,onReset:y,meta:h}){if(!l&&!g)return null;const s=l&&/storage\.rcs-rds\.ro/.test(l),n=s?"Stored in DigiStorage ✅":"Upload successful",r=s?"Your photo is now saved securely in DigiStorage.":null;return m.jsxs("div",{className:"upload-status",role:"status",children:[l&&m.jsxs("div",{className:"success-block",children:[m.jsx("p",{children:n}),r&&m.jsx("p",{className:"storage-note",children:r}),h&&m.jsxs("p",{className:"meta-note",children:["Resolution: ",h.width,"×",h.height,"px · Approx ",(h.approxSize/1024).toFixed(1)," KB"]}),m.jsx("a",{href:l,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),g&&m.jsx("div",{className:"error-block",role:"alert",children:m.jsx("p",{children:g})}),m.jsx("button",{type:"button",className:"btn",onClick:y,children:l?"Upload Another":"Try Again"})]})}let _=null;const q="https://storage.rcs-rds.ro";function G(){return q.replace(/\/$/,"")}function A(){return G()}function N(){return`${A()}/api/v2`}function V(){return`${A()}/content/api/v2`}async function J(l,g){return new Promise((y,h)=>{const s=new FileReader;s.onerror=()=>h(s.error),s.onload=()=>{y(s.result)},s.readAsDataURL(l)})}async function P(){return"490b2d11-2568-428c-a4a7-f1cd7f30d5bd".trim()}async function T(){if(_)return _;const l=await P(),g=await fetch(`${N()}/mounts`,{headers:{Authorization:`Token token="${l}"`,Accept:"application/json"}});if(!g.ok){const n=await g.text();throw new Error(`Failed to list mounts: ${g.status} ${n}`)}const s=((await g.json()).mounts||[]).find(n=>n.type==="device");if(!s)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return _=s.id,_}async function Q(l,g,y){const h=await P(),s=await T(),n=l.endsWith("/")?l:l+"/",r=`${V()}/mounts/${s}/files/put?path=${encodeURIComponent(n)}`,d=new FormData;d.append("file",y,g);const u=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${h}"`},body:d});if(!u.ok){const U=await u.text();throw new Error(`Upload failed: ${u.status} ${U}`)}return u.json().catch(()=>null)}async function K(l){const g=await P(),y=await T(),h=`${N()}/mounts/${y}/files/download?path=${encodeURIComponent(l)}`,s=await fetch(h,{headers:{Authorization:`Token token="${g}"`,Accept:"application/json"}});if(!s.ok){const r=await s.text();throw new Error(`Failed to obtain download link: ${s.status} ${r}`)}const n=await s.json();if(!n.link)throw new Error("Download link response missing `link`");return n.link}async function X({blob:l,fileName:g,contentType:y="image/jpeg"}){if(!(l instanceof Blob))throw new Error("blob must be a Blob");if(!g)throw new Error("fileName required");const h="/uploads".trim(),s=h.startsWith("/")?h:"/"+h,n=async()=>{console.log("📤 Attempting direct DigiStorage upload (token mode)...");try{await Q(s,g,l);const v=(s.endsWith("/")?s:s+"/")+g,M=await K(v);return console.log("✅ Direct DigiStorage upload succeeded"),M}catch(v){throw console.error("❌ Direct upload failed:",v),v}},r="/.netlify/functions/upload-photo",d=await J(l);let u;try{u=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:g,dataUrl:d})})}catch(v){return console.warn("⚠️ Serverless upload unreachable, attempting direct token mode fallback...",v.message),n()}if(!u.ok){const v=await u.text();console.warn(`⚠️ Serverless upload failed (${u.status}). Will attempt direct token mode. Details: ${v}`);try{return await n()}catch(M){throw new Error(`Serverless failed (${u.status}); Direct token attempt also failed: ${M.message}`)}}const U=await u.json().catch(()=>({}));return U.url?(console.log("✅ DigiStorage upload complete via serverless function"),U.url):(console.warn("⚠️ Serverless response missing url, attempting direct token mode"),n())}function Z(){const[l,g]=j.useState(null),[y,h]=j.useState(null),[s,n]=j.useState(null),[r,d]=j.useState(!1),[u,U]=j.useState(null),[v,M]=j.useState(null),c=j.useCallback(()=>{g(null),h(null),n(null),d(!1),U(null),M(null)},[]),a=t=>{g(t.dataUrl),h(t.blob),n({width:t.width,height:t.height,approxSize:t.approxSize}),M(null)},e=async()=>{if(y)try{d(!0),M(null);const t=`photo_${Date.now()}.jpg`,i=await X({blob:y,fileName:t});U(i)}catch(t){console.error(t),M(t.message||"Upload failed")}finally{d(!1)}};return m.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[m.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!l&&!u&&!v&&m.jsx(B,{onCapture:a,disabled:r}),l&&!u&&!v&&m.jsx(H,{dataUrl:l,onRetake:c,onUpload:e,uploading:r}),(u||v)&&m.jsx(L,{url:u,error:v,onReset:c,meta:s}),m.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely."})]})}export{Z as default};
