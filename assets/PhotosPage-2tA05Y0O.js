import{b as A,r as x,c as D,j as p}from"./index-D9KVlpF9.js";var O={exports:{}};(function(s,f){(function(l,n){s.exports=n(x)})(D,function(h){return function(l){var n={};function o(r){if(n[r])return n[r].exports;var d=n[r]={i:r,l:!1,exports:{}};return l[r].call(d.exports,d,d.exports,o),d.l=!0,d.exports}return o.m=l,o.c=n,o.d=function(r,d,u){o.o(r,d)||Object.defineProperty(r,d,{enumerable:!0,get:u})},o.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},o.t=function(r,d){if(d&1&&(r=o(r)),d&8||d&4&&typeof r=="object"&&r&&r.__esModule)return r;var u=Object.create(null);if(o.r(u),Object.defineProperty(u,"default",{enumerable:!0,value:r}),d&2&&typeof r!="string")for(var M in r)o.d(u,M,(function(b){return r[b]}).bind(null,M));return u},o.n=function(r){var d=r&&r.__esModule?function(){return r.default}:function(){return r};return o.d(d,"a",d),d},o.o=function(r,d){return Object.prototype.hasOwnProperty.call(r,d)},o.p="",o(o.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(l,n,o){o.r(n);var r=o("react"),d=function(){var g=function(c,e){return g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,a){t.__proto__=a}||function(t,a){for(var i in a)a.hasOwnProperty(i)&&(t[i]=a[i])},g(c,e)};return function(c,e){g(c,e);function t(){this.constructor=c}c.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),u=function(){return u=Object.assign||function(g){for(var c,e=1,t=arguments.length;e<t;e++){c=arguments[e];for(var a in c)Object.prototype.hasOwnProperty.call(c,a)&&(g[a]=c[a])}return g},u.apply(this,arguments)},M=function(g,c){var e={};for(var t in g)Object.prototype.hasOwnProperty.call(g,t)&&c.indexOf(t)<0&&(e[t]=g[t]);if(g!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,t=Object.getOwnPropertySymbols(g);a<t.length;a++)c.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(g,t[a])&&(e[t[a]]=g[t[a]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(c){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,a){e.call(navigator,c,t,a)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function b(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var j=function(g){d(c,g);function c(e){var t=g.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return c.prototype.componentDidMount=function(){var e=this,t=e.state,a=e.props;if(this.unmounted=!1,!b()){a.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),a.children&&typeof a.children!="function"&&console.warn("children must be a function")},c.prototype.componentDidUpdate=function(e){var t=this.props;if(!b()){t.onUserMediaError("getUserMedia not supported");return}var a=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),i=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),S=e.minScreenshotWidth!==t.minScreenshotWidth,y=e.minScreenshotHeight!==t.minScreenshotHeight;(i||S||y)&&(this.canvas=null,this.ctx=null),(a||i)&&(this.stopAndCleanup(),this.requestUserMedia())},c.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},c.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},c.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(c.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},c.prototype.getScreenshot=function(e){var t=this,a=t.state,i=t.props;if(!a.hasUserMedia)return null;var S=this.getCanvas(e);return S&&S.toDataURL(i.screenshotFormat,i.screenshotQuality)},c.prototype.getCanvas=function(e){var t=this,a=t.state,i=t.props;if(!this.video||!a.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var S=this.video.videoWidth,y=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var m=S/y;S=i.minScreenshotWidth||this.video.clientWidth,y=S/m,i.minScreenshotHeight&&y<i.minScreenshotHeight&&(y=i.minScreenshotHeight,S=y*m)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||S,this.canvas.height=(e==null?void 0:e.height)||y,this.ctx=this.canvas.getContext("2d")}var U=this,w=U.ctx,v=U.canvas;return w&&v&&(v.width=(e==null?void 0:e.width)||v.width,v.height=(e==null?void 0:e.height)||v.height,i.mirrored&&(w.translate(v.width,0),w.scale(-1,1)),w.imageSmoothingEnabled=i.imageSmoothing,w.drawImage(this.video,0,0,(e==null?void 0:e.width)||v.width,(e==null?void 0:e.height)||v.height),i.mirrored&&(w.scale(-1,1),w.translate(-v.width,0))),v},c.prototype.requestUserMedia=function(){var e=this,t=this.props,a=function(y,m){var U={video:typeof m<"u"?m:!0};t.audio&&(U.audio=typeof y<"u"?y:!0),e.requestUserMediaId++;var w=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(U).then(function(v){e.unmounted||w!==e.requestUserMediaId?c.stopMediaStream(v):e.handleUserMedia(null,v)}).catch(function(v){e.handleUserMedia(v)})};if("mediaDevices"in navigator)a(t.audioConstraints,t.videoConstraints);else{var i=function(y){return{optional:[{sourceId:y}]}},S=function(y){var m=y.deviceId;return typeof m=="string"?m:Array.isArray(m)&&m.length>0?m[0]:typeof m=="object"&&m.ideal?m.ideal:null};MediaStreamTrack.getSources(function(y){var m=null,U=null;y.forEach(function(k){k.kind==="audio"?m=k.id:k.kind==="video"&&(U=k.id)});var w=S(t.audioConstraints);w&&(m=w);var v=S(t.videoConstraints);v&&(U=v),a(i(m),i(U))})}},c.prototype.handleUserMedia=function(e,t){var a=this.props;if(e||!t){this.setState({hasUserMedia:!1}),a.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}a.onUserMedia(t)},c.prototype.render=function(){var e=this,t=this,a=t.state,i=t.props,S=i.audio;i.forceScreenshotSourceSize;var y=i.disablePictureInPicture;i.onUserMedia,i.onUserMediaError,i.screenshotFormat,i.screenshotQuality,i.minScreenshotWidth,i.minScreenshotHeight,i.audioConstraints,i.videoConstraints,i.imageSmoothing;var m=i.mirrored,U=i.style,w=U===void 0?{}:U,v=i.children,k=M(i,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),N=m?u(u({},w),{transform:(w.transform||"")+" scaleX(-1)"}):w,T={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",u({autoPlay:!0,disablePictureInPicture:y,src:a.src,muted:!S,playsInline:!0,ref:function($){e.video=$},style:N},k)),v&&v(T))},c.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},c}(r.Component);n.default=j},react:function(l,n){l.exports=h}}).default})})(O);var R=O.exports;const F=A(R);function W({onCapture:s,disabled:f=!1}){const h=x.useRef(null),l=x.useCallback(()=>{if(!h.current)return;const n=h.current.getScreenshot();n&&s(n)},[s]);return p.jsxs("div",{className:"photo-capture",children:[p.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:p.jsx(F,{ref:h,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),p.jsx("button",{className:"btn primary",onClick:l,disabled:f,type:"button",children:"Capture"})]})}function L({dataUrl:s,onRetake:f,onUpload:h,uploading:l}){return s?p.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[p.jsx("img",{src:s,alt:"Captured preview",className:"preview-image"}),p.jsxs("div",{className:"actions",children:[p.jsx("button",{className:"btn",type:"button",onClick:f,disabled:l,children:"Retake"}),p.jsx("button",{className:"btn primary",type:"button",onClick:h,disabled:l,children:l?"Uploading…":"Upload"})]})]}):null}function q({url:s,error:f,onReset:h}){if(!s&&!f)return null;const l=s&&/storage\.rcs-rds\.ro/.test(s),n=l?"Stored in DigiStorage ✅":"Upload successful",o=l?"Your photo is now saved securely in DigiStorage.":null;return p.jsxs("div",{className:"upload-status",role:"status",children:[s&&p.jsxs("div",{className:"success-block",children:[p.jsx("p",{children:n}),o&&p.jsx("p",{className:"storage-note",children:o}),p.jsx("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),f&&p.jsx("div",{className:"error-block",role:"alert",children:p.jsx("p",{children:f})}),p.jsx("button",{type:"button",className:"btn",onClick:h,children:s?"Upload Another":"Try Again"})]})}let C=null;const z="https://storage.rcs-rds.ro";function H(){return z.replace(/\/$/,"")}function P(){return H()}function E(){return`${P()}/api/v2`}function G(){return`${P()}/content/api/v2`}async function V(s,f){return new Promise((h,l)=>{const n=new FileReader;n.onerror=()=>l(n.error),n.onload=()=>{h(n.result)},n.readAsDataURL(s)})}async function _(){return"490b2d11-2568-428c-a4a7-f1cd7f30d5bd".trim()}async function I(){if(C)return C;const s=await _(),f=await fetch(`${E()}/mounts`,{headers:{Authorization:`Token token="${s}"`,Accept:"application/json"}});if(!f.ok){const o=await f.text();throw new Error(`Failed to list mounts: ${f.status} ${o}`)}const n=((await f.json()).mounts||[]).find(o=>o.type==="device");if(!n)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return C=n.id,C}async function B(s,f,h){const l=await _(),n=await I(),o=s.endsWith("/")?s:s+"/",r=`${G()}/mounts/${n}/files/put?path=${encodeURIComponent(o)}`,d=new FormData;d.append("file",h,f);const u=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${l}"`},body:d});if(!u.ok){const M=await u.text();throw new Error(`Upload failed: ${u.status} ${M}`)}return u.json().catch(()=>null)}async function J(s){const f=await _(),h=await I(),l=`${E()}/mounts/${h}/files/download?path=${encodeURIComponent(s)}`,n=await fetch(l,{headers:{Authorization:`Token token="${f}"`,Accept:"application/json"}});if(!n.ok){const r=await n.text();throw new Error(`Failed to obtain download link: ${n.status} ${r}`)}const o=await n.json();if(!o.link)throw new Error("Download link response missing `link`");return o.link}async function Q({blob:s,fileName:f,contentType:h="image/jpeg"}){if(!(s instanceof Blob))throw new Error("blob must be a Blob");if(!f)throw new Error("fileName required");const l="/uploads".trim(),n=l.startsWith("/")?l:"/"+l,o=async()=>{console.log("📤 Attempting direct DigiStorage upload (token mode)...");try{await B(n,f,s);const b=(n.endsWith("/")?n:n+"/")+f,j=await J(b);return console.log("✅ Direct DigiStorage upload succeeded"),j}catch(b){throw console.error("❌ Direct upload failed:",b),b}},r="/.netlify/functions/upload-photo",d=await V(s);let u;try{u=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:f,dataUrl:d})})}catch(b){return console.warn("⚠️ Serverless upload unreachable, attempting direct token mode fallback...",b.message),o()}if(!u.ok){const b=await u.text();console.warn(`⚠️ Serverless upload failed (${u.status}). Will attempt direct token mode. Details: ${b}`);try{return await o()}catch(j){throw new Error(`Serverless failed (${u.status}); Direct token attempt also failed: ${j.message}`)}}const M=await u.json().catch(()=>({}));return M.url?(console.log("✅ DigiStorage upload complete via serverless function"),M.url):(console.warn("⚠️ Serverless response missing url, attempting direct token mode"),o())}function X(){const[s,f]=x.useState(null),[h,l]=x.useState(!1),[n,o]=x.useState(null),[r,d]=x.useState(null),u=x.useCallback(()=>{f(null),l(!1),o(null),d(null)},[]),M=j=>{f(j),d(null)},b=async()=>{if(s)try{l(!0),d(null);const g=await(await fetch(s)).blob(),c=`photo_${Date.now()}.jpg`,e=await Q({blob:g,fileName:c});o(e)}catch(j){console.error(j),d(j.message||"Upload failed")}finally{l(!1)}};return p.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[p.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!s&&!n&&!r&&p.jsx(W,{onCapture:M,disabled:h}),s&&!n&&!r&&p.jsx(L,{dataUrl:s,onRetake:u,onUpload:b,uploading:h}),(n||r)&&p.jsx(q,{url:n,error:r,onReset:u}),p.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{X as default};
