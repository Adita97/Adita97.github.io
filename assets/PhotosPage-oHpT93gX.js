import{b as D,r as M,c as $,j as f}from"./index-pi34R_Er.js";var O={exports:{}};(function(a,u){(function(d,n){a.exports=n(M)})($,function(p){return function(d){var n={};function o(r){if(n[r])return n[r].exports;var c=n[r]={i:r,l:!1,exports:{}};return d[r].call(c.exports,c,c.exports,o),c.l=!0,c.exports}return o.m=d,o.c=n,o.d=function(r,c,h){o.o(r,c)||Object.defineProperty(r,c,{enumerable:!0,get:h})},o.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},o.t=function(r,c){if(c&1&&(r=o(r)),c&8||c&4&&typeof r=="object"&&r&&r.__esModule)return r;var h=Object.create(null);if(o.r(h),Object.defineProperty(h,"default",{enumerable:!0,value:r}),c&2&&typeof r!="string")for(var S in r)o.d(h,S,(function(x){return r[x]}).bind(null,S));return h},o.n=function(r){var c=r&&r.__esModule?function(){return r.default}:function(){return r};return o.d(c,"a",c),c},o.o=function(r,c){return Object.prototype.hasOwnProperty.call(r,c)},o.p="",o(o.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(d,n,o){o.r(n);var r=o("react"),c=function(){var g=function(l,e){return g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var i in s)s.hasOwnProperty(i)&&(t[i]=s[i])},g(l,e)};return function(l,e){g(l,e);function t(){this.constructor=l}l.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),h=function(){return h=Object.assign||function(g){for(var l,e=1,t=arguments.length;e<t;e++){l=arguments[e];for(var s in l)Object.prototype.hasOwnProperty.call(l,s)&&(g[s]=l[s])}return g},h.apply(this,arguments)},S=function(g,l){var e={};for(var t in g)Object.prototype.hasOwnProperty.call(g,t)&&l.indexOf(t)<0&&(e[t]=g[t]);if(g!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,t=Object.getOwnPropertySymbols(g);s<t.length;s++)l.indexOf(t[s])<0&&Object.prototype.propertyIsEnumerable.call(g,t[s])&&(e[t[s]]=g[t[s]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(l){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,s){e.call(navigator,l,t,s)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function x(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var j=function(g){c(l,g);function l(e){var t=g.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return l.prototype.componentDidMount=function(){var e=this,t=e.state,s=e.props;if(this.unmounted=!1,!x()){s.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),s.children&&typeof s.children!="function"&&console.warn("children must be a function")},l.prototype.componentDidUpdate=function(e){var t=this.props;if(!x()){t.onUserMediaError("getUserMedia not supported");return}var s=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),i=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),b=e.minScreenshotWidth!==t.minScreenshotWidth,w=e.minScreenshotHeight!==t.minScreenshotHeight;(i||b||w)&&(this.canvas=null,this.ctx=null),(s||i)&&(this.stopAndCleanup(),this.requestUserMedia())},l.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},l.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},l.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(l.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},l.prototype.getScreenshot=function(e){var t=this,s=t.state,i=t.props;if(!s.hasUserMedia)return null;var b=this.getCanvas(e);return b&&b.toDataURL(i.screenshotFormat,i.screenshotQuality)},l.prototype.getCanvas=function(e){var t=this,s=t.state,i=t.props;if(!this.video||!s.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var b=this.video.videoWidth,w=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var m=b/w;b=i.minScreenshotWidth||this.video.clientWidth,w=b/m,i.minScreenshotHeight&&w<i.minScreenshotHeight&&(w=i.minScreenshotHeight,b=w*m)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||b,this.canvas.height=(e==null?void 0:e.height)||w,this.ctx=this.canvas.getContext("2d")}var U=this,y=U.ctx,v=U.canvas;return y&&v&&(v.width=(e==null?void 0:e.width)||v.width,v.height=(e==null?void 0:e.height)||v.height,i.mirrored&&(y.translate(v.width,0),y.scale(-1,1)),y.imageSmoothingEnabled=i.imageSmoothing,y.drawImage(this.video,0,0,(e==null?void 0:e.width)||v.width,(e==null?void 0:e.height)||v.height),i.mirrored&&(y.scale(-1,1),y.translate(-v.width,0))),v},l.prototype.requestUserMedia=function(){var e=this,t=this.props,s=function(w,m){var U={video:typeof m<"u"?m:!0};t.audio&&(U.audio=typeof w<"u"?w:!0),e.requestUserMediaId++;var y=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(U).then(function(v){e.unmounted||y!==e.requestUserMediaId?l.stopMediaStream(v):e.handleUserMedia(null,v)}).catch(function(v){e.handleUserMedia(v)})};if("mediaDevices"in navigator)s(t.audioConstraints,t.videoConstraints);else{var i=function(w){return{optional:[{sourceId:w}]}},b=function(w){var m=w.deviceId;return typeof m=="string"?m:Array.isArray(m)&&m.length>0?m[0]:typeof m=="object"&&m.ideal?m.ideal:null};MediaStreamTrack.getSources(function(w){var m=null,U=null;w.forEach(function(k){k.kind==="audio"?m=k.id:k.kind==="video"&&(U=k.id)});var y=b(t.audioConstraints);y&&(m=y);var v=b(t.videoConstraints);v&&(U=v),s(i(m),i(U))})}},l.prototype.handleUserMedia=function(e,t){var s=this.props;if(e||!t){this.setState({hasUserMedia:!1}),s.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}s.onUserMedia(t)},l.prototype.render=function(){var e=this,t=this,s=t.state,i=t.props,b=i.audio;i.forceScreenshotSourceSize;var w=i.disablePictureInPicture;i.onUserMedia,i.onUserMediaError,i.screenshotFormat,i.screenshotQuality,i.minScreenshotWidth,i.minScreenshotHeight,i.audioConstraints,i.videoConstraints,i.imageSmoothing;var m=i.mirrored,U=i.style,y=U===void 0?{}:U,v=i.children,k=S(i,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),T=m?h(h({},y),{transform:(y.transform||"")+" scaleX(-1)"}):y,N={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",h({autoPlay:!0,disablePictureInPicture:w,src:s.src,muted:!b,playsInline:!0,ref:function(A){e.video=A},style:T},k)),v&&v(N))},l.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},l}(r.Component);n.default=j},react:function(d,n){d.exports=p}}).default})})(O);var R=O.exports;const L=D(R);function W({onCapture:a,disabled:u=!1}){const p=M.useRef(null),d=M.useCallback(()=>{if(!p.current)return;const n=p.current.getScreenshot();n&&a(n)},[a]);return f.jsxs("div",{className:"photo-capture",children:[f.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:f.jsx(L,{ref:p,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),f.jsx("button",{className:"btn primary",onClick:d,disabled:u,type:"button",children:"Capture"})]})}function F({dataUrl:a,onRetake:u,onUpload:p,uploading:d}){return a?f.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[f.jsx("img",{src:a,alt:"Captured preview",className:"preview-image"}),f.jsxs("div",{className:"actions",children:[f.jsx("button",{className:"btn",type:"button",onClick:u,disabled:d,children:"Retake"}),f.jsx("button",{className:"btn primary",type:"button",onClick:p,disabled:d,children:d?"Uploading…":"Upload"})]})]}):null}function G({url:a,error:u,onReset:p}){if(!a&&!u)return null;const d=a&&a.startsWith("blob:"),n=a&&!d&&/storage\.rcs-rds\.ro/.test(a);let o="Upload successful!",r=null;return d?(o="Photo captured (not persisted)",r="⚠️ This preview URL is temporary and will be lost on refresh."):n&&(o="Stored in DigiStorage ✅",r="Your photo is now saved securely in DigiStorage."),f.jsxs("div",{className:"upload-status",role:"status",children:[a&&f.jsxs("div",{className:"success-block",children:[f.jsx("p",{children:o}),r&&f.jsx("p",{className:d?"fallback-note":"storage-note",children:r}),f.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:d?"View Photo (Local)":"View Photo"})]}),u&&f.jsx("div",{className:"error-block",role:"alert",children:f.jsx("p",{children:u})}),f.jsx("button",{type:"button",className:"btn",onClick:p,children:a?"Upload Another":"Try Again"})]})}let _=null;const V="https://storage.rcs-rds.ro";function q(){return V.replace(/\/$/,"")}function P(){return q()}function E(){return`${P()}/api/v2`}function z(){return`${P()}/content/api/v2`}async function H(a,u="application/octet-stream"){return new Promise((p,d)=>{const n=new FileReader;n.onerror=()=>d(n.error),n.onload=()=>p(`data:${u};base64,${btoa(n.result.split(",")[1]||"")}`),n.readAsDataURL(a)})}async function C(){throw new Error("DigiStorage token unavailable. Provide VITE_DIGI_TOKEN or (VITE_DIGI_EMAIL + VITE_DIGI_PASSWORD) for dev.")}async function I(){if(_)return _;const a=await C(),u=await fetch(`${E()}/mounts`,{headers:{Authorization:`Token token="${a}"`,Accept:"application/json"}});if(!u.ok){const o=await u.text();throw new Error(`Failed to list mounts: ${u.status} ${o}`)}const n=((await u.json()).mounts||[]).find(o=>o.type==="device");if(!n)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return _=n.id,_}async function B(a,u,p){const d=await C(),n=await I(),o=a.endsWith("/")?a:a+"/",r=`${z()}/mounts/${n}/files/put?path=${encodeURIComponent(o)}`,c=new FormData;c.append("file",p,u);const h=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${d}"`},body:c});if(!h.ok){const S=await h.text();throw new Error(`Upload failed: ${h.status} ${S}`)}return h.json().catch(()=>null)}async function J(a){const u=await C(),p=await I(),d=`${E()}/mounts/${p}/files/download?path=${encodeURIComponent(a)}`,n=await fetch(d,{headers:{Authorization:`Token token="${u}"`,Accept:"application/json"}});if(!n.ok){const r=await n.text();throw new Error(`Failed to obtain download link: ${n.status} ${r}`)}const o=await n.json();if(!o.link)throw new Error("Download link response missing `link`");return o.link}async function Q({blob:a,fileName:u,contentType:p="image/jpeg"}){if(!(a instanceof Blob))throw new Error("blob must be a Blob");if(!u)throw new Error("fileName required");try{const n="/.netlify/functions/upload-photo",o=await H(a,p),r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:u,dataUrl:o})});if(r.ok){const c=await r.json();if(c.url)return console.log("✅ Uploaded via serverless function"),c.url}else{const c=await r.text();console.warn("Serverless upload attempt failed",r.status,c)}}catch(n){console.info("Serverless endpoint not available or failed, falling back to direct Digi flow.",n.message)}try{const n="/";await B(n,u,a);const o=(n.endsWith("/")?n:n+"/")+u,r=await J(o);return console.log("✅ Direct Digi upload succeeded"),r}catch(n){console.warn("Direct Digi upload failed:",n.message)}const d=URL.createObjectURL(a);return console.warn("⚠️ Using non-persistent local fallback URL"),d}function X(){const[a,u]=M.useState(null),[p,d]=M.useState(!1),[n,o]=M.useState(null),[r,c]=M.useState(null),h=M.useCallback(()=>{u(null),d(!1),o(null),c(null)},[]),S=j=>{u(j),c(null)},x=async()=>{if(a)try{d(!0),c(null);const g=await(await fetch(a)).blob(),l=`photo_${Date.now()}.jpg`,e=await Q({blob:g,fileName:l});o(e)}catch(j){console.error(j),c(j.message||"Upload failed")}finally{d(!1)}};return f.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[f.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!a&&!n&&!r&&f.jsx(W,{onCapture:S,disabled:p}),a&&!n&&!r&&f.jsx(F,{dataUrl:a,onRetake:h,onUpload:x,uploading:p}),(n||r)&&f.jsx(G,{url:n,error:r,onReset:h}),f.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{X as default};
