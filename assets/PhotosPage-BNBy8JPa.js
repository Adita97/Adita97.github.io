import{b as N,r as w,c as k,j as u}from"./index-VkmNPsdU.js";var P={exports:{}};(function(d,b){(function(l,c){d.exports=c(w)})(k,function(m){return function(l){var c={};function a(r){if(c[r])return c[r].exports;var s=c[r]={i:r,l:!1,exports:{}};return l[r].call(s.exports,s,s.exports,a),s.l=!0,s.exports}return a.m=l,a.c=c,a.d=function(r,s,g){a.o(r,s)||Object.defineProperty(r,s,{enumerable:!0,get:g})},a.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},a.t=function(r,s){if(s&1&&(r=a(r)),s&8||s&4&&typeof r=="object"&&r&&r.__esModule)return r;var g=Object.create(null);if(a.r(g),Object.defineProperty(g,"default",{enumerable:!0,value:r}),s&2&&typeof r!="string")for(var j in r)a.d(g,j,(function(x){return r[x]}).bind(null,j));return g},a.n=function(r){var s=r&&r.__esModule?function(){return r.default}:function(){return r};return a.d(s,"a",s),s},a.o=function(r,s){return Object.prototype.hasOwnProperty.call(r,s)},a.p="",a(a.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(l,c,a){a.r(c);var r=a("react"),s=function(){var p=function(o,e){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},p(o,e)};return function(o,e){p(o,e);function t(){this.constructor=o}o.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),g=function(){return g=Object.assign||function(p){for(var o,e=1,t=arguments.length;e<t;e++){o=arguments[e];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(p[n]=o[n])}return p},g.apply(this,arguments)},j=function(p,o){var e={};for(var t in p)Object.prototype.hasOwnProperty.call(p,t)&&o.indexOf(t)<0&&(e[t]=p[t]);if(p!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,t=Object.getOwnPropertySymbols(p);n<t.length;n++)o.indexOf(t[n])<0&&Object.prototype.propertyIsEnumerable.call(p,t[n])&&(e[t[n]]=p[t[n]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(o){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,n){e.call(navigator,o,t,n)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function x(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var M=function(p){s(o,p);function o(e){var t=p.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return o.prototype.componentDidMount=function(){var e=this,t=e.state,n=e.props;if(this.unmounted=!1,!x()){n.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),n.children&&typeof n.children!="function"&&console.warn("children must be a function")},o.prototype.componentDidUpdate=function(e){var t=this.props;if(!x()){t.onUserMediaError("getUserMedia not supported");return}var n=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),i=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),S=e.minScreenshotWidth!==t.minScreenshotWidth,v=e.minScreenshotHeight!==t.minScreenshotHeight;(i||S||v)&&(this.canvas=null,this.ctx=null),(n||i)&&(this.stopAndCleanup(),this.requestUserMedia())},o.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},o.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},o.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(o.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},o.prototype.getScreenshot=function(e){var t=this,n=t.state,i=t.props;if(!n.hasUserMedia)return null;var S=this.getCanvas(e);return S&&S.toDataURL(i.screenshotFormat,i.screenshotQuality)},o.prototype.getCanvas=function(e){var t=this,n=t.state,i=t.props;if(!this.video||!n.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var S=this.video.videoWidth,v=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var h=S/v;S=i.minScreenshotWidth||this.video.clientWidth,v=S/h,i.minScreenshotHeight&&v<i.minScreenshotHeight&&(v=i.minScreenshotHeight,S=v*h)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||S,this.canvas.height=(e==null?void 0:e.height)||v,this.ctx=this.canvas.getContext("2d")}var U=this,y=U.ctx,f=U.canvas;return y&&f&&(f.width=(e==null?void 0:e.width)||f.width,f.height=(e==null?void 0:e.height)||f.height,i.mirrored&&(y.translate(f.width,0),y.scale(-1,1)),y.imageSmoothingEnabled=i.imageSmoothing,y.drawImage(this.video,0,0,(e==null?void 0:e.width)||f.width,(e==null?void 0:e.height)||f.height),i.mirrored&&(y.scale(-1,1),y.translate(-f.width,0))),f},o.prototype.requestUserMedia=function(){var e=this,t=this.props,n=function(v,h){var U={video:typeof h<"u"?h:!0};t.audio&&(U.audio=typeof v<"u"?v:!0),e.requestUserMediaId++;var y=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(U).then(function(f){e.unmounted||y!==e.requestUserMediaId?o.stopMediaStream(f):e.handleUserMedia(null,f)}).catch(function(f){e.handleUserMedia(f)})};if("mediaDevices"in navigator)n(t.audioConstraints,t.videoConstraints);else{var i=function(v){return{optional:[{sourceId:v}]}},S=function(v){var h=v.deviceId;return typeof h=="string"?h:Array.isArray(h)&&h.length>0?h[0]:typeof h=="object"&&h.ideal?h.ideal:null};MediaStreamTrack.getSources(function(v){var h=null,U=null;v.forEach(function(C){C.kind==="audio"?h=C.id:C.kind==="video"&&(U=C.id)});var y=S(t.audioConstraints);y&&(h=y);var f=S(t.videoConstraints);f&&(U=f),n(i(h),i(U))})}},o.prototype.handleUserMedia=function(e,t){var n=this.props;if(e||!t){this.setState({hasUserMedia:!1}),n.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}n.onUserMedia(t)},o.prototype.render=function(){var e=this,t=this,n=t.state,i=t.props,S=i.audio;i.forceScreenshotSourceSize;var v=i.disablePictureInPicture;i.onUserMedia,i.onUserMediaError,i.screenshotFormat,i.screenshotQuality,i.minScreenshotWidth,i.minScreenshotHeight,i.audioConstraints,i.videoConstraints,i.imageSmoothing;var h=i.mirrored,U=i.style,y=U===void 0?{}:U,f=i.children,C=j(i,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),O=h?g(g({},y),{transform:(y.transform||"")+" scaleX(-1)"}):y,_={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",g({autoPlay:!0,disablePictureInPicture:v,src:n.src,muted:!S,playsInline:!0,ref:function(E){e.video=E},style:O},C)),f&&f(_))},o.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},o}(r.Component);c.default=M},react:function(l,c){l.exports=m}}).default})})(P);var I=P.exports;const T=N(I);function A({onCapture:d,disabled:b=!1}){const m=w.useRef(null),l=w.useCallback(()=>{if(!m.current)return;const c=m.current.getScreenshot();c&&d(c)},[d]);return u.jsxs("div",{className:"photo-capture",children:[u.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:u.jsx(T,{ref:m,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),u.jsx("button",{className:"btn primary",onClick:l,disabled:b,type:"button",children:"Capture"})]})}function R({dataUrl:d,onRetake:b,onUpload:m,uploading:l}){return d?u.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[u.jsx("img",{src:d,alt:"Captured preview",className:"preview-image"}),u.jsxs("div",{className:"actions",children:[u.jsx("button",{className:"btn",type:"button",onClick:b,disabled:l,children:"Retake"}),u.jsx("button",{className:"btn primary",type:"button",onClick:m,disabled:l,children:l?"Uploading…":"Upload"})]})]}):null}function W({url:d,error:b,onReset:m}){if(!d&&!b)return null;const l=d&&/storage\.rcs-rds\.ro/.test(d),c=l?"Stored in DigiStorage ✅":"Upload successful",a=l?"Your photo is now saved securely in DigiStorage.":null;return u.jsxs("div",{className:"upload-status",role:"status",children:[d&&u.jsxs("div",{className:"success-block",children:[u.jsx("p",{children:c}),a&&u.jsx("p",{className:"storage-note",children:a}),u.jsx("a",{href:d,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),b&&u.jsx("div",{className:"error-block",role:"alert",children:u.jsx("p",{children:b})}),u.jsx("button",{type:"button",className:"btn",onClick:m,children:d?"Upload Another":"Try Again"})]})}async function q(d,b){return new Promise((m,l)=>{const c=new FileReader;c.onerror=()=>l(c.error),c.onload=()=>{m(c.result)},c.readAsDataURL(d)})}async function F({blob:d,fileName:b,contentType:m="image/jpeg"}){if(!(d instanceof Blob))throw new Error("blob must be a Blob");if(!b)throw new Error("fileName required");const l="/.netlify/functions/upload-photo",c=await q(d);let a;try{a=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:b,dataUrl:c})})}catch(s){throw new Error(`Upload service unreachable. Ensure deployment is on Netlify (not pure GitHub Pages). Network error: ${s.message}`)}if(!a.ok){const s=await a.text();throw new Error(`Serverless upload failed (${a.status}): ${s}`)}const r=await a.json().catch(()=>({}));if(!r.url)throw new Error("Upload response missing url");return console.log("✅ DigiStorage upload complete via serverless function"),r.url}function D(){const[d,b]=w.useState(null),[m,l]=w.useState(!1),[c,a]=w.useState(null),[r,s]=w.useState(null),g=w.useCallback(()=>{b(null),l(!1),a(null),s(null)},[]),j=M=>{b(M),s(null)},x=async()=>{if(d)try{l(!0),s(null);const p=await(await fetch(d)).blob(),o=`photo_${Date.now()}.jpg`,e=await F({blob:p,fileName:o});a(e)}catch(M){console.error(M),s(M.message||"Upload failed")}finally{l(!1)}};return u.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[u.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!d&&!c&&!r&&u.jsx(A,{onCapture:j,disabled:m}),d&&!c&&!r&&u.jsx(R,{dataUrl:d,onRetake:g,onUpload:x,uploading:m}),(c||r)&&u.jsx(W,{url:c,error:r,onReset:g}),u.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{D as default};
