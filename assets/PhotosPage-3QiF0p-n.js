import{b as W,r as M,c as G,j as p}from"./index-BsmUdcDF.js";var I={exports:{}};(function(c,l){(function(i,a){c.exports=a(M)})(G,function(h){return function(i){var a={};function o(r){if(a[r])return a[r].exports;var d=a[r]={i:r,l:!1,exports:{}};return i[r].call(d.exports,d,d.exports,o),d.l=!0,d.exports}return o.m=i,o.c=a,o.d=function(r,d,f){o.o(r,d)||Object.defineProperty(r,d,{enumerable:!0,get:f})},o.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},o.t=function(r,d){if(d&1&&(r=o(r)),d&8||d&4&&typeof r=="object"&&r&&r.__esModule)return r;var f=Object.create(null);if(o.r(f),Object.defineProperty(f,"default",{enumerable:!0,value:r}),d&2&&typeof r!="string")for(var U in r)o.d(f,U,(function(j){return r[j]}).bind(null,U));return f},o.n=function(r){var d=r&&r.__esModule?function(){return r.default}:function(){return r};return o.d(d,"a",d),d},o.o=function(r,d){return Object.prototype.hasOwnProperty.call(r,d)},o.p="",o(o.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(i,a,o){o.r(a);var r=o("react"),d=function(){var v=function(u,e){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var n in s)s.hasOwnProperty(n)&&(t[n]=s[n])},v(u,e)};return function(u,e){v(u,e);function t(){this.constructor=u}u.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),f=function(){return f=Object.assign||function(v){for(var u,e=1,t=arguments.length;e<t;e++){u=arguments[e];for(var s in u)Object.prototype.hasOwnProperty.call(u,s)&&(v[s]=u[s])}return v},f.apply(this,arguments)},U=function(v,u){var e={};for(var t in v)Object.prototype.hasOwnProperty.call(v,t)&&u.indexOf(t)<0&&(e[t]=v[t]);if(v!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,t=Object.getOwnPropertySymbols(v);s<t.length;s++)u.indexOf(t[s])<0&&Object.prototype.propertyIsEnumerable.call(v,t[s])&&(e[t[s]]=v[t[s]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(u){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,s){e.call(navigator,u,t,s)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function j(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var x=function(v){d(u,v);function u(e){var t=v.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return u.prototype.componentDidMount=function(){var e=this,t=e.state,s=e.props;if(this.unmounted=!1,!j()){s.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),s.children&&typeof s.children!="function"&&console.warn("children must be a function")},u.prototype.componentDidUpdate=function(e){var t=this.props;if(!j()){t.onUserMediaError("getUserMedia not supported");return}var s=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),n=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),b=e.minScreenshotWidth!==t.minScreenshotWidth,w=e.minScreenshotHeight!==t.minScreenshotHeight;(n||b||w)&&(this.canvas=null,this.ctx=null),(s||n)&&(this.stopAndCleanup(),this.requestUserMedia())},u.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},u.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},u.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(u.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},u.prototype.getScreenshot=function(e){var t=this,s=t.state,n=t.props;if(!s.hasUserMedia)return null;var b=this.getCanvas(e);return b&&b.toDataURL(n.screenshotFormat,n.screenshotQuality)},u.prototype.getCanvas=function(e){var t=this,s=t.state,n=t.props;if(!this.video||!s.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var b=this.video.videoWidth,w=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var m=b/w;b=n.minScreenshotWidth||this.video.clientWidth,w=b/m,n.minScreenshotHeight&&w<n.minScreenshotHeight&&(w=n.minScreenshotHeight,b=w*m)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||b,this.canvas.height=(e==null?void 0:e.height)||w,this.ctx=this.canvas.getContext("2d")}var S=this,y=S.ctx,g=S.canvas;return y&&g&&(g.width=(e==null?void 0:e.width)||g.width,g.height=(e==null?void 0:e.height)||g.height,n.mirrored&&(y.translate(g.width,0),y.scale(-1,1)),y.imageSmoothingEnabled=n.imageSmoothing,y.drawImage(this.video,0,0,(e==null?void 0:e.width)||g.width,(e==null?void 0:e.height)||g.height),n.mirrored&&(y.scale(-1,1),y.translate(-g.width,0))),g},u.prototype.requestUserMedia=function(){var e=this,t=this.props,s=function(w,m){var S={video:typeof m<"u"?m:!0};t.audio&&(S.audio=typeof w<"u"?w:!0),e.requestUserMediaId++;var y=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(S).then(function(g){e.unmounted||y!==e.requestUserMediaId?u.stopMediaStream(g):e.handleUserMedia(null,g)}).catch(function(g){e.handleUserMedia(g)})};if("mediaDevices"in navigator)s(t.audioConstraints,t.videoConstraints);else{var n=function(w){return{optional:[{sourceId:w}]}},b=function(w){var m=w.deviceId;return typeof m=="string"?m:Array.isArray(m)&&m.length>0?m[0]:typeof m=="object"&&m.ideal?m.ideal:null};MediaStreamTrack.getSources(function(w){var m=null,S=null;w.forEach(function(k){k.kind==="audio"?m=k.id:k.kind==="video"&&(S=k.id)});var y=b(t.audioConstraints);y&&(m=y);var g=b(t.videoConstraints);g&&(S=g),s(n(m),n(S))})}},u.prototype.handleUserMedia=function(e,t){var s=this.props;if(e||!t){this.setState({hasUserMedia:!1}),s.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}s.onUserMedia(t)},u.prototype.render=function(){var e=this,t=this,s=t.state,n=t.props,b=n.audio;n.forceScreenshotSourceSize;var w=n.disablePictureInPicture;n.onUserMedia,n.onUserMediaError,n.screenshotFormat,n.screenshotQuality,n.minScreenshotWidth,n.minScreenshotHeight,n.audioConstraints,n.videoConstraints,n.imageSmoothing;var m=n.mirrored,S=n.style,y=S===void 0?{}:S,g=n.children,k=U(n,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),D=m?f(f({},y),{transform:(y.transform||"")+" scaleX(-1)"}):y,F={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",f({autoPlay:!0,disablePictureInPicture:w,src:s.src,muted:!b,playsInline:!0,ref:function(R){e.video=R},style:D},k)),g&&g(F))},u.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},u}(r.Component);a.default=x},react:function(i,a){i.exports=h}}).default})})(I);var q=I.exports;const z=W(q);function L({onCapture:c,disabled:l=!1}){const h=M.useRef(null),i=M.useCallback(()=>{if(!h.current)return;const a=h.current.getScreenshot();a&&c(a)},[c]);return p.jsxs("div",{className:"photo-capture",children:[p.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:p.jsx(z,{ref:h,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),p.jsx("button",{className:"btn primary",onClick:i,disabled:l,type:"button",children:"Capture"})]})}function H({dataUrl:c,onRetake:l,onUpload:h,uploading:i}){return c?p.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[p.jsx("img",{src:c,alt:"Captured preview",className:"preview-image"}),p.jsxs("div",{className:"actions",children:[p.jsx("button",{className:"btn",type:"button",onClick:l,disabled:i,children:"Retake"}),p.jsx("button",{className:"btn primary",type:"button",onClick:h,disabled:i,children:i?"Uploading…":"Upload"})]})]}):null}function V({url:c,error:l,onReset:h}){return!c&&!l?null:p.jsxs("div",{className:"upload-status",role:"status",children:[c&&p.jsxs("div",{className:"success-block",children:[p.jsx("p",{children:"Upload successful!"}),p.jsx("a",{href:c,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:"View Photo"})]}),l&&p.jsx("div",{className:"error-block",role:"alert",children:p.jsx("p",{children:l})}),p.jsx("button",{type:"button",className:"btn",onClick:h,children:c?"Upload Another":"Try Again"})]})}let C=null,P=0,E=null;const B="https://storage.rcs-rds.ro";function _(){return B.replace(/\/$/,"")}function $(){return`${_()}/api/v2`}function T(){return`${_()}/content/api/v2`}function A(){return Date.now()}async function O(){if(C&&A()-P<15*60*1e3)return C;const c="marius.adrian997@gmail.com",l="19971005Gma!",h=`${_()}/token`.replace(/\/$/,"");console.log("🔐 Attempting DigiStorage authentication...",{endpoint:h,email:(c==null?void 0:c.substring(0,5))+"..."});let i;try{i=await fetch(h,{method:"GET",headers:{"X-Koofr-Email":c,"X-Koofr-Password":l,Accept:"*/*"}})}catch(o){throw console.error("❌ Network error during DigiStorage authentication:",o),new Error(`Network error connecting to DigiStorage: ${o.message}. This might be a CORS issue - consider using a backend proxy for production.`)}if(!i.ok){const o=await i.text();throw console.error("❌ DigiStorage auth failed:",{status:i.status,text:o}),new Error(`Failed to obtain DigiStorage token (GET headers auth) ${i.status}: ${o}`)}const a=i.headers.get("X-Koofr-Token");if(console.log("🔑 DigiStorage auth response:",{status:i.status,hasToken:!!a,headers:Object.fromEntries(i.headers.entries())}),!a)throw new Error("Token header X-Koofr-Token missing in response");return C=a,P=A(),console.log("✅ DigiStorage token obtained successfully"),C}async function N(){if(E)return E;const c=await O();console.log("🗂️ Fetching mounts list...");const l=await fetch(`${$()}/mounts`,{headers:{Authorization:`Token token="${c}"`,Accept:"application/json"}});if(!l.ok){const o=await l.text();throw console.error("❌ Failed to list mounts:",{status:l.status,text:o}),new Error(`Failed to list mounts: ${l.status} ${o}`)}const h=await l.json();console.log("🗂️ Mounts response:",h);const i=h.mounts||[],a=i.find(o=>o.type==="device");if(console.log("🗂️ Available mounts:",i.map(o=>({id:o.id,name:o.name,type:o.type}))),console.log("🗂️ Selected device mount:",a),!a)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return E=a.id,E}async function K(c,l,h){const i=await O(),a=await N(),o=c.endsWith("/")?c:c+"/",r=`${T()}/mounts/${a}/files/put?path=${encodeURIComponent(o)}`;console.log("📤 Starting DirectMultipartUpload...",{folderPath:c,fileName:l,mountId:a,normalizedFolder:o,url:r,contentApiV2Base:T()});const d=new FormData;d.append("file",h,l);const f=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${i}"`},body:d});if(console.log("📤 Upload response:",{status:f.status,statusText:f.statusText,url:f.url}),!f.ok){const U=await f.text();throw console.error("❌ Upload failed:",{status:f.status,text:U,url:r}),new Error(`Upload failed: ${f.status} ${U}`)}return f.json().catch(()=>null)}async function X(c){const l=await O(),h=await N(),i=`${$()}/mounts/${h}/files/download?path=${encodeURIComponent(c)}`,a=await fetch(i,{headers:{Authorization:`Token token="${l}"`,Accept:"application/json"}});if(!a.ok){const r=await a.text();throw new Error(`Failed to obtain download link: ${a.status} ${r}`)}const o=await a.json();if(!o.link)throw new Error("Download link response missing `link`");return o.link}async function J({blob:c,fileName:l,contentType:h="image/jpeg"}){if(!(c instanceof Blob))throw new Error("blob must be a Blob");if(!l)throw new Error("fileName required");const i="/uploads";await K(i,l,c);const a=(i.endsWith("/")?i:i+"/")+l;return await X(a)}function Y(){const[c,l]=M.useState(null),[h,i]=M.useState(!1),[a,o]=M.useState(null),[r,d]=M.useState(null),f=M.useCallback(()=>{l(null),i(!1),o(null),d(null)},[]),U=x=>{l(x),d(null)},j=async()=>{if(c)try{i(!0),d(null);const v=await(await fetch(c)).blob(),u=`photo_${Date.now()}.jpg`,e=await J({blob:v,fileName:u});o(e)}catch(x){console.error(x),d(x.message||"Upload failed")}finally{i(!1)}};return p.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[p.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!c&&!a&&!r&&p.jsx(L,{onCapture:U,disabled:h}),c&&!a&&!r&&p.jsx(H,{dataUrl:c,onRetake:f,onUpload:j,uploading:h}),(a||r)&&p.jsx(V,{url:a,error:r,onReset:f}),p.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{Y as default};
