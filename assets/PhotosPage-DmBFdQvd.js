import{b as F,r as k,c as W,j as f}from"./index-BO6PpGak.js";var N={exports:{}};(function(a,u){(function(o,c){a.exports=c(k)})(W,function(h){return function(o){var c={};function n(r){if(c[r])return c[r].exports;var l=c[r]={i:r,l:!1,exports:{}};return o[r].call(l.exports,l,l.exports,n),l.l=!0,l.exports}return n.m=o,n.c=c,n.d=function(r,l,p){n.o(r,l)||Object.defineProperty(r,l,{enumerable:!0,get:p})},n.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n.t=function(r,l){if(l&1&&(r=n(r)),l&8||l&4&&typeof r=="object"&&r&&r.__esModule)return r;var p=Object.create(null);if(n.r(p),Object.defineProperty(p,"default",{enumerable:!0,value:r}),l&2&&typeof r!="string")for(var U in r)n.d(p,U,(function(x){return r[x]}).bind(null,U));return p},n.n=function(r){var l=r&&r.__esModule?function(){return r.default}:function(){return r};return n.d(l,"a",l),l},n.o=function(r,l){return Object.prototype.hasOwnProperty.call(r,l)},n.p="",n(n.s="./src/react-webcam.tsx")}({"./src/react-webcam.tsx":function(o,c,n){n.r(c);var r=n("react"),l=function(){var v=function(d,e){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var i in s)s.hasOwnProperty(i)&&(t[i]=s[i])},v(d,e)};return function(d,e){v(d,e);function t(){this.constructor=d}d.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}}(),p=function(){return p=Object.assign||function(v){for(var d,e=1,t=arguments.length;e<t;e++){d=arguments[e];for(var s in d)Object.prototype.hasOwnProperty.call(d,s)&&(v[s]=d[s])}return v},p.apply(this,arguments)},U=function(v,d){var e={};for(var t in v)Object.prototype.hasOwnProperty.call(v,t)&&d.indexOf(t)<0&&(e[t]=v[t]);if(v!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,t=Object.getOwnPropertySymbols(v);s<t.length;s++)d.indexOf(t[s])<0&&Object.prototype.propertyIsEnumerable.call(v,t[s])&&(e[t[s]]=v[t[s]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(d){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(t,s){e.call(navigator,d,t,s)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function x(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var M=function(v){l(d,v);function d(e){var t=v.call(this,e)||this;return t.canvas=null,t.ctx=null,t.requestUserMediaId=0,t.unmounted=!1,t.state={hasUserMedia:!1},t}return d.prototype.componentDidMount=function(){var e=this,t=e.state,s=e.props;if(this.unmounted=!1,!x()){s.onUserMediaError("getUserMedia not supported");return}t.hasUserMedia||this.requestUserMedia(),s.children&&typeof s.children!="function"&&console.warn("children must be a function")},d.prototype.componentDidUpdate=function(e){var t=this.props;if(!x()){t.onUserMediaError("getUserMedia not supported");return}var s=JSON.stringify(e.audioConstraints)!==JSON.stringify(t.audioConstraints),i=JSON.stringify(e.videoConstraints)!==JSON.stringify(t.videoConstraints),y=e.minScreenshotWidth!==t.minScreenshotWidth,w=e.minScreenshotHeight!==t.minScreenshotHeight;(i||y||w)&&(this.canvas=null,this.ctx=null),(s||i)&&(this.stopAndCleanup(),this.requestUserMedia())},d.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},d.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(t){e.removeTrack(t),t.stop()}),e.getAudioTracks().map(function(t){e.removeTrack(t),t.stop()})):e.stop())},d.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(d.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},d.prototype.getScreenshot=function(e){var t=this,s=t.state,i=t.props;if(!s.hasUserMedia)return null;var y=this.getCanvas(e);return y&&y.toDataURL(i.screenshotFormat,i.screenshotQuality)},d.prototype.getCanvas=function(e){var t=this,s=t.state,i=t.props;if(!this.video||!s.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var y=this.video.videoWidth,w=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var m=y/w;y=i.minScreenshotWidth||this.video.clientWidth,w=y/m,i.minScreenshotHeight&&w<i.minScreenshotHeight&&(w=i.minScreenshotHeight,y=w*m)}this.canvas=document.createElement("canvas"),this.canvas.width=(e==null?void 0:e.width)||y,this.canvas.height=(e==null?void 0:e.height)||w,this.ctx=this.canvas.getContext("2d")}var S=this,b=S.ctx,g=S.canvas;return b&&g&&(g.width=(e==null?void 0:e.width)||g.width,g.height=(e==null?void 0:e.height)||g.height,i.mirrored&&(b.translate(g.width,0),b.scale(-1,1)),b.imageSmoothingEnabled=i.imageSmoothing,b.drawImage(this.video,0,0,(e==null?void 0:e.width)||g.width,(e==null?void 0:e.height)||g.height),i.mirrored&&(b.scale(-1,1),b.translate(-g.width,0))),g},d.prototype.requestUserMedia=function(){var e=this,t=this.props,s=function(w,m){var S={video:typeof m<"u"?m:!0};t.audio&&(S.audio=typeof w<"u"?w:!0),e.requestUserMediaId++;var b=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(S).then(function(g){e.unmounted||b!==e.requestUserMediaId?d.stopMediaStream(g):e.handleUserMedia(null,g)}).catch(function(g){e.handleUserMedia(g)})};if("mediaDevices"in navigator)s(t.audioConstraints,t.videoConstraints);else{var i=function(w){return{optional:[{sourceId:w}]}},y=function(w){var m=w.deviceId;return typeof m=="string"?m:Array.isArray(m)&&m.length>0?m[0]:typeof m=="object"&&m.ideal?m.ideal:null};MediaStreamTrack.getSources(function(w){var m=null,S=null;w.forEach(function(j){j.kind==="audio"?m=j.id:j.kind==="video"&&(S=j.id)});var b=y(t.audioConstraints);b&&(m=b);var g=y(t.videoConstraints);g&&(S=g),s(i(m),i(S))})}},d.prototype.handleUserMedia=function(e,t){var s=this.props;if(e||!t){this.setState({hasUserMedia:!1}),s.onUserMediaError(e);return}this.stream=t;try{this.video&&(this.video.srcObject=t),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(t)})}s.onUserMedia(t)},d.prototype.render=function(){var e=this,t=this,s=t.state,i=t.props,y=i.audio;i.forceScreenshotSourceSize;var w=i.disablePictureInPicture;i.onUserMedia,i.onUserMediaError,i.screenshotFormat,i.screenshotQuality,i.minScreenshotWidth,i.minScreenshotHeight,i.audioConstraints,i.videoConstraints,i.imageSmoothing;var m=i.mirrored,S=i.style,b=S===void 0?{}:S,g=i.children,j=U(i,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),A=m?p(p({},b),{transform:(b.transform||"")+" scaleX(-1)"}):b,D={getScreenshot:this.getScreenshot.bind(this)};return r.createElement(r.Fragment,null,r.createElement("video",p({autoPlay:!0,disablePictureInPicture:w,src:s.src,muted:!y,playsInline:!0,ref:function(R){e.video=R},style:A},j)),g&&g(D))},d.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},d}(r.Component);c.default=M},react:function(o,c){o.exports=h}}).default})})(N);var L=N.exports;const G=F(L);function q({onCapture:a,disabled:u=!1}){const h=k.useRef(null),o=k.useCallback(()=>{if(!h.current)return;const c=h.current.getScreenshot();c&&a(c)},[a]);return f.jsxs("div",{className:"photo-capture",children:[f.jsx("div",{className:"camera-frame",role:"region","aria-label":"Camera preview",children:f.jsx(G,{ref:h,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"user"},className:"webcam-feed"})}),f.jsx("button",{className:"btn primary",onClick:o,disabled:u,type:"button",children:"Capture"})]})}function z({dataUrl:a,onRetake:u,onUpload:h,uploading:o}){return a?f.jsxs("div",{className:"photo-preview",role:"region","aria-label":"Photo preview",children:[f.jsx("img",{src:a,alt:"Captured preview",className:"preview-image"}),f.jsxs("div",{className:"actions",children:[f.jsx("button",{className:"btn",type:"button",onClick:u,disabled:o,children:"Retake"}),f.jsx("button",{className:"btn primary",type:"button",onClick:h,disabled:o,children:o?"Uploading‚Ä¶":"Upload"})]})]}):null}function H({url:a,error:u,onReset:h}){if(!a&&!u)return null;const o=a&&a.startsWith("blob:");return f.jsxs("div",{className:"upload-status",role:"status",children:[a&&f.jsxs("div",{className:"success-block",children:[f.jsx("p",{children:o?"Photo captured successfully!":"Upload successful!"}),o&&f.jsx("p",{className:"fallback-note",children:"‚ö†Ô∏è Note: Photo is temporarily stored locally. For permanent storage, a backend service is needed."}),f.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"uploaded-link",children:o?"View Photo (Local)":"View Photo"})]}),u&&f.jsx("div",{className:"error-block",role:"alert",children:f.jsx("p",{children:u})}),f.jsx("button",{type:"button",className:"btn",onClick:h,children:a?"Upload Another":"Try Again"})]})}let C=null,_=0,E=null;const V="https://storage.rcs-rds.ro";function B(){return V.replace(/\/$/,"")}function O(){return B()}function I(){return`${O()}/api/v2`}function K(){return`${O()}/content/api/v2`}function T(){return Date.now()}async function P(){if(C&&T()-_<15*60*1e3)return C;const a="marius.adrian997@gmail.com",u="19971005Gma!",h=`${O()}/token`.replace(/\/$/,"");console.log("üîê Attempting DigiStorage authentication...",{endpoint:h,email:(a==null?void 0:a.substring(0,5))+"..."});let o;try{o=await fetch(h,{method:"GET",headers:{"X-Koofr-Email":a,"X-Koofr-Password":u,Accept:"*/*"}})}catch(n){throw console.error("‚ùå Network error during DigiStorage authentication:",n),new Error(`Network error connecting to DigiStorage: ${n.message}. This might be a CORS issue - consider using a backend proxy for production.`)}if(!o.ok){const n=await o.text();throw console.error("‚ùå DigiStorage auth failed:",{status:o.status,text:n}),new Error(`Failed to obtain DigiStorage token (GET headers auth) ${o.status}: ${n}`)}const c=o.headers.get("X-Koofr-Token");if(console.log("üîë DigiStorage auth response:",{status:o.status,hasToken:!!c,headers:Object.fromEntries(o.headers.entries())}),!c)throw new Error("Token header X-Koofr-Token missing in response");return C=c,_=T(),console.log("‚úÖ DigiStorage token obtained successfully"),C}async function $(){if(E)return E;const a=await P(),u=await fetch(`${I()}/mounts`,{headers:{Authorization:`Token token="${a}"`,Accept:"application/json"}});if(!u.ok){const n=await u.text();throw new Error(`Failed to list mounts: ${u.status} ${n}`)}const c=((await u.json()).mounts||[]).find(n=>n.type==="device");if(!c)throw new Error("No device mount found. Set VITE_DIGI_MOUNT_ID.");return E=c.id,E}async function X(a,u,h){const o=await P(),c=await $(),n=a.endsWith("/")?a:a+"/",r=`${K()}/mounts/${c}/files/put?path=${encodeURIComponent(n)}`,l=new FormData;l.append("file",h,u);const p=await fetch(r,{method:"POST",headers:{Authorization:`Token token="${o}"`},body:l});if(!p.ok){const U=await p.text();throw new Error(`Upload failed: ${p.status} ${U}`)}return p.json().catch(()=>null)}async function J(a){const u=await P(),h=await $(),o=`${I()}/mounts/${h}/files/download?path=${encodeURIComponent(a)}`,c=await fetch(o,{headers:{Authorization:`Token token="${u}"`,Accept:"application/json"}});if(!c.ok){const r=await c.text();throw new Error(`Failed to obtain download link: ${c.status} ${r}`)}const n=await c.json();if(!n.link)throw new Error("Download link response missing `link`");return n.link}async function Q({blob:a,fileName:u,contentType:h="image/jpeg"}){if(!(a instanceof Blob))throw new Error("blob must be a Blob");if(!u)throw new Error("fileName required");try{const o="/uploads";await X(o,u,a);const c=(o.endsWith("/")?o:o+"/")+u;return await J(c)}catch(o){return console.warn("‚ö†Ô∏è DigiStorage upload failed, using local fallback:",o.message),console.info("‚ÑπÔ∏è Production note: Direct browser uploads to DigiStorage are blocked by CORS. Consider implementing a backend upload service."),URL.createObjectURL(a)}}function Z(){const[a,u]=k.useState(null),[h,o]=k.useState(!1),[c,n]=k.useState(null),[r,l]=k.useState(null),p=k.useCallback(()=>{u(null),o(!1),n(null),l(null)},[]),U=M=>{u(M),l(null)},x=async()=>{if(a)try{o(!0),l(null);const v=await(await fetch(a)).blob(),d=`photo_${Date.now()}.jpg`,e=await Q({blob:v,fileName:d});n(e)}catch(M){console.error(M),l(M.message||"Upload failed")}finally{o(!1)}};return f.jsxs("main",{className:"photos-page","aria-labelledby":"photos-title",children:[f.jsx("h1",{id:"photos-title",className:"photos-heading",children:"Take a Photo"}),!a&&!c&&!r&&f.jsx(q,{onCapture:U,disabled:h}),a&&!c&&!r&&f.jsx(z,{dataUrl:a,onRetake:p,onUpload:x,uploading:h}),(c||r)&&f.jsx(H,{url:c,error:r,onReset:p}),f.jsx("p",{className:"privacy-hint",children:"Images are uploaded securely. Avoid capturing sensitive information."})]})}export{Z as default};
